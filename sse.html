<!DOCTYPE html>
<html lang="en">

<head>
    <title>File Uploader</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link href="/public/assets/style.css" rel="stylesheet">
    <script src="/public/assets/script.js"></script>

</head>

<body>

    <div class="container d-flex flex-column align-items-center">
        <h1>Upload Progress....</h1>
    </div>

    <body>

        <div class="h-100 d-flex align-items-center justify-content-center">
            <div class="container mt-5">
                <div class="progress-custom">
                    <div class="progress">
                        <div id="progress-bar" class="progress-bar progress-bar-striped" role="progressbar"
                            aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 60%;"></div>
                    </div>
                    <div class="progress-value text-success">

                        <span class="current-processing-task">1</span> / 10 completed
                    </div>
                </div>
            </div>
        </div>
    </body>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.min.js"
        integrity="sha512-3dZ9wIrMMij8rOH7X3kLfXAzwtcHpuYpEgQg1OA4QAob1e81H8ntUQmQm3pBudqIoySO5j0tHN4ENzA6+n2r4w=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

</body>

<script>
    const eventSource = new EventSource('http://localhost:8080/progress');

eventSource.addEventListener('progress', function (event) {
    const data = JSON.parse(event.data)

    if (data.currentTask != undefined) {
        progressBar(data)
    }

    if (data.completed == true) {
        closeEventStream()
    }

});

eventSource.onmessage = (event) => {
    const data = JSON.parse(event.data)
    console.log("on message : ",data)
}

eventSource.onerror = (error) => {
    console.error('SSE error:', error);
};

// Either this or the up one
eventSource.addEventListener('error', (error) => {
    console.error('SSE error:', error);
});

eventSource.onopen = () => {
    console.log('SSE connection opened');
};

eventSource.onclose = () => {
    console.log('SSE connection closed');
};

function closeEventStream(){
    console.log("event stream closed")
    eventSource.close() 
}

function progressBar(data){

    // Get the progress bar element
    const progressBar = document.getElementById('progress-bar');
    progressBar.style.width = `${data.progressPercentage}%`;

    // set the indicator
    const progressIndicators = document.getElementsByClassName("current-processing-task")
    // Iterate over the collection of elements and update their text content
    for (let i = 0; i < progressIndicators.length; i++) {
        progressIndicators[i].textContent = data.currentTask;
    }
}
</script>

</html>